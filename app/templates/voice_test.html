<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Input Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3>Voice Input Test</h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="test-result" class="form-label">Test Results:</label>
                            <div id="test-result" class="alert alert-info">
                                Click "Test Whisper" to check if the speech recognition is working.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <button id="test-whisper-btn" class="btn btn-primary">Test Whisper Model</button>
                            <button id="test-mic-btn" class="btn btn-success ms-2">Test Microphone</button>
                            <button id="test-voice-btn" class="btn btn-warning ms-2">Test Voice Recording</button>
                            <button id="debug-audio-btn" class="btn btn-info ms-2">Debug Audio</button>
                            <button id="test-format-btn" class="btn btn-secondary ms-2">Test Audio Format</button>
                        </div>
                        
                        <div class="mb-3">
                            <label for="voice-input" class="form-label">Voice Input Test:</label>
                            <div class="input-group">
                                <input type="text" id="voice-input" class="form-control" placeholder="Speak here..." readonly>
                                <button id="voice-mic-btn" class="btn btn-outline-secondary" type="button">
                                    <span id="voice-mic-icon">üé§</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="debug-info" class="form-label">Debug Information:</label>
                            <textarea id="debug-info" class="form-control" rows="10" readonly></textarea>
                        </div>
                        
                        <div class="mt-3">
                            <a href="/editor" class="btn btn-secondary">Back to Editor</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function log(message) {
            const debugInfo = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.value += `[${timestamp}] ${message}\n`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        // Test Whisper Model
        document.getElementById('test-whisper-btn').onclick = async function() {
            log('Testing Whisper model...');
            try {
                const response = await fetch('/api/test-whisper');
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('test-result').innerHTML = `<div class="alert alert-success">‚úÖ ${data.status}</div>`;
                    log(`Whisper test: ${data.status}`);
                } else {
                    document.getElementById('test-result').innerHTML = `<div class="alert alert-danger">‚ùå ${data.error}</div>`;
                    log(`Whisper test failed: ${data.error}`);
                }
            } catch (error) {
                document.getElementById('test-result').innerHTML = `<div class="alert alert-danger">‚ùå Error: ${error.message}</div>`;
                log(`Whisper test error: ${error.message}`);
            }
        };

        // Test Microphone
        document.getElementById('test-mic-btn').onclick = async function() {
            log('Testing microphone access...');
            if (!navigator.mediaDevices) {
                document.getElementById('test-result').innerHTML = '<div class="alert alert-danger">‚ùå Browser does not support media devices</div>';
                log('Browser does not support media devices');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                document.getElementById('test-result').innerHTML = '<div class="alert alert-success">‚úÖ Microphone access granted</div>';
                log('Microphone access granted');
                stream.getTracks().forEach(track => track.stop());
            } catch (error) {
                document.getElementById('test-result').innerHTML = `<div class="alert alert-danger">‚ùå Microphone access denied: ${error.message}</div>`;
                log(`Microphone access denied: ${error.message}`);
            }
        };

        // Test Voice Recording
        document.getElementById('test-voice-btn').onclick = async function() {
            log('Testing voice recording...');
            if (!navigator.mediaDevices) {
                document.getElementById('test-result').innerHTML = '<div class="alert alert-danger">‚ùå Browser does not support media devices</div>';
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                let mimeType = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/webm';
                }
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/mp4';
                }
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/wav';
                }
                
                log(`Using MIME type: ${mimeType}`);
                
                const mediaRecorder = new MediaRecorder(stream, { mimeType });
                const audioChunks = [];
                
                mediaRecorder.ondataavailable = e => {
                    audioChunks.push(e.data);
                    log(`Audio chunk received: ${e.data.size} bytes`);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    log(`Recording complete: ${audioBlob.size} bytes total`);
                    
                    if (audioBlob.size === 0) {
                        document.getElementById('test-result').innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è No audio recorded</div>';
                        log('No audio recorded');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'test.wav');
                    formData.append('language', 'python');
                    
                    try {
                        const response = await fetch('/api/speech-to-code', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        log(`Server response: ${JSON.stringify(data)}`);
                        
                        if (response.ok && data.prompt) {
                            document.getElementById('test-result').innerHTML = `<div class="alert alert-success">‚úÖ Voice recording successful! Transcribed: "${data.prompt}"</div>`;
                        } else {
                            document.getElementById('test-result').innerHTML = `<div class="alert alert-danger">‚ùå Voice recording failed: ${data.error}</div>`;
                        }
                    } catch (error) {
                        document.getElementById('test-result').innerHTML = `<div class="alert alert-danger">‚ùå Server error: ${error.message}</div>`;
                        log(`Server error: ${error.message}`);
                    }
                };
                
                mediaRecorder.start();
                document.getElementById('test-result').innerHTML = '<div class="alert alert-info">üé§ Recording... Speak now!</div>';
                log('Started recording');
                
                setTimeout(() => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        log('Stopped recording after timeout');
                    }
                }, 3000);
                
            } catch (error) {
                document.getElementById('test-result').innerHTML = `<div class="alert alert-danger">‚ùå Recording error: ${error.message}</div>`;
                log(`Recording error: ${error.message}`);
            }
        };

        // Debug Audio Test
        document.getElementById('debug-audio-btn').onclick = async function() {
            log('Testing audio debug...');
            if (!navigator.mediaDevices) {
                document.getElementById('test-result').innerHTML = '<div class="alert alert-danger">‚ùå Browser does not support media devices</div>';
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                let mimeType = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/webm';
                }
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/mp4';
                }
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/wav';
                }
                
                const mediaRecorder = new MediaRecorder(stream, { mimeType });
                const audioChunks = [];
                
                mediaRecorder.ondataavailable = e => {
                    audioChunks.push(e.data);
                    log(`Audio chunk received: ${e.data.size} bytes`);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    log(`Recording complete: ${audioBlob.size} bytes total`);
                    
                    if (audioBlob.size === 0) {
                        document.getElementById('test-result').innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è No audio recorded</div>';
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'debug.wav');
                    
                    try {
                        const response = await fetch('/api/debug-audio', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        log(`Debug response: ${JSON.stringify(data, null, 2)}`);
                        
                        if (response.ok) {
                            document.getElementById('test-result').innerHTML = `<div class="alert alert-success">‚úÖ Audio debug successful! Check console for details.</div>`;
                        } else {
                            document.getElementById('test-result').innerHTML = `<div class="alert alert-danger">‚ùå Debug failed: ${data.error}</div>`;
                        }
                    } catch (error) {
                        document.getElementById('test-result').innerHTML = `<div class="alert alert-danger">‚ùå Debug error: ${error.message}</div>`;
                        log(`Debug error: ${error.message}`);
                    }
                };
                
                mediaRecorder.start();
                document.getElementById('test-result').innerHTML = '<div class="alert alert-info">üé§ Recording for debug... Speak now!</div>';
                log('Started debug recording');
                
                setTimeout(() => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        log('Stopped debug recording');
                    }
                }, 3000);
                
            } catch (error) {
                document.getElementById('test-result').innerHTML = `<div class="alert alert-danger">‚ùå Debug error: ${error.message}</div>`;
                log(`Debug error: ${error.message}`);
            }
        };

        // Test Audio Format
        document.getElementById('test-format-btn').onclick = async function() {
            log('Testing audio format...');
            if (!navigator.mediaDevices) {
                document.getElementById('test-result').innerHTML = '<div class="alert alert-danger">‚ùå Browser does not support media devices</div>';
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                let mimeType = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/webm';
                }
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/mp4';
                }
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/wav';
                }
                
                const mediaRecorder = new MediaRecorder(stream, { mimeType });
                const audioChunks = [];
                
                mediaRecorder.ondataavailable = e => {
                    audioChunks.push(e.data);
                    log(`Audio chunk received: ${e.data.size} bytes`);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    log(`Recording complete: ${audioBlob.size} bytes total`);
                    
                    if (audioBlob.size === 0) {
                        document.getElementById('test-result').innerHTML = '<div class="alert alert-warning">‚ö†Ô∏è No audio recorded</div>';
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'format_test.wav');
                    
                    try {
                        const response = await fetch('/api/test-audio-format', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        log(`Format test response: ${JSON.stringify(data, null, 2)}`);
                        
                        if (response.ok) {
                            document.getElementById('test-result').innerHTML = `<div class="alert alert-success">‚úÖ Audio format test successful! Format: ${data.detected_format}, Size: ${data.file_size} bytes</div>`;
                        } else {
                            document.getElementById('test-result').innerHTML = `<div class="alert alert-danger">‚ùå Format test failed: ${data.error}</div>`;
                        }
                    } catch (error) {
                        document.getElementById('test-result').innerHTML = `<div class="alert alert-danger">‚ùå Format test error: ${error.message}</div>`;
                        log(`Format test error: ${error.message}`);
                    }
                };
                
                mediaRecorder.start();
                document.getElementById('test-result').innerHTML = '<div class="alert alert-info">üé§ Recording for format test... Speak now!</div>';
                log('Started format test recording');
                
                setTimeout(() => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        log('Stopped format test recording');
                    }
                }, 3000);
                
            } catch (error) {
                document.getElementById('test-result').innerHTML = `<div class="alert alert-danger">‚ùå Format test error: ${error.message}</div>`;
                log(`Format test error: ${error.message}`);
            }
        };

        // Voice input test
        let voiceMediaRecorder;
        let voiceAudioChunks = [];

        document.getElementById('voice-mic-btn').onclick = async function() {
            if (!navigator.mediaDevices) {
                alert("Your browser does not support audio recording.");
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                let mimeType = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/webm';
                }
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/mp4';
                }
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/wav';
                }
                
                voiceMediaRecorder = new MediaRecorder(stream, { mimeType });
                voiceAudioChunks = [];
                
                voiceMediaRecorder.ondataavailable = e => voiceAudioChunks.push(e.data);
                voiceMediaRecorder.onstop = async () => {
                    try {
                        const audioBlob = new Blob(voiceAudioChunks, { type: mimeType });
                        
                        if (audioBlob.size === 0) {
                            throw new Error('No audio recorded');
                        }
                        
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'speech.wav');
                        formData.append('language', 'python');

                        document.getElementById('voice-mic-icon').textContent = "‚è≥";
                        const res = await fetch('/api/speech-to-code', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await res.json();
                        document.getElementById('voice-mic-icon').textContent = "üé§";
                        
                        if (res.ok && data.prompt) {
                            document.getElementById('voice-input').value = data.prompt;
                            log(`Voice input successful: "${data.prompt}"`);
                        } else {
                            log(`Voice input failed: ${data.error}`);
                            alert(data.error || "Failed to transcribe voice input.");
                        }
                    } catch (error) {
                        document.getElementById('voice-mic-icon').textContent = "üé§";
                        log(`Voice input error: ${error.message}`);
                        alert(error.message);
                    }
                };
                
                voiceMediaRecorder.start();
                document.getElementById('voice-mic-icon').textContent = "üî¥";
                log('Started voice input recording');
                
                setTimeout(() => {
                    if (voiceMediaRecorder.state === 'recording') {
                        voiceMediaRecorder.stop();
                        log('Stopped voice input recording');
                    }
                }, 5000);
                
            } catch (error) {
                log(`Voice input setup error: ${error.message}`);
                alert(`Error accessing microphone: ${error.message}`);
            }
        };

        // Initialize debug info
        log('Voice test page loaded');
        log(`User agent: ${navigator.userAgent}`);
        log(`MediaRecorder supported: ${typeof MediaRecorder !== 'undefined'}`);
        if (typeof MediaRecorder !== 'undefined') {
            log(`Supported MIME types:`);
            ['audio/webm;codecs=opus', 'audio/webm', 'audio/mp4', 'audio/wav'].forEach(type => {
                log(`  ${type}: ${MediaRecorder.isTypeSupported(type)}`);
            });
        }
    </script>
</body>
</html> 